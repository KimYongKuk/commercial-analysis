# RAG ê²€ìƒ‰ ë¡œì§ ì™„ë²½ ê°€ì´ë“œ

## ëª©ì°¨
1. [ì „ì²´ íë¦„ë„](#ì „ì²´-íë¦„ë„)
2. [í•µì‹¬ ê°œë…: Distance vs Similarity](#í•µì‹¬-ê°œë…-distance-vs-similarity)
3. [ì„ê³„ê°’ í•„í„°ë§ ë¡œì§](#ì„ê³„ê°’-í•„í„°ë§-ë¡œì§)
4. [ê²€ìƒ‰ ê²°ê³¼ 0ê±´ì´ ë°œìƒí•˜ëŠ” ì´ìœ ](#ê²€ìƒ‰-ê²°ê³¼-0ê±´ì´-ë°œìƒí•˜ëŠ”-ì´ìœ )
5. [ì‹¤ì œ ì½”ë“œ ë¶„ì„](#ì‹¤ì œ-ì½”ë“œ-ë¶„ì„)
6. [ì‹¤ì „ ì˜ˆì‹œ](#ì‹¤ì „-ì˜ˆì‹œ)
7. [íŠœë‹ ê°€ì´ë“œ](#íŠœë‹-ê°€ì´ë“œ)

---

## ì „ì²´ íë¦„ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ì‚¬ìš©ì ì§ˆë¬¸ ì…ë ¥                                          â”‚
â”‚    ì˜ˆ: "ê°•ë‚¨ì—ì„œ ì¹´í˜ ì°½ì—… ë¹„ìš©ì€?"                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Retriever.search(query) í˜¸ì¶œ                             â”‚
â”‚    íŒŒì¼: backend/rag/retriever.py:49                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. BGE-M3-KO ì„ë² ë”© ìƒì„±                                    â”‚
â”‚    - ì§ˆë¬¸ì„ 1024ì°¨ì› ë²¡í„°ë¡œ ë³€í™˜                            â”‚
â”‚    - ì˜ˆ: [0.23, -0.45, 0.78, ..., 0.12]                     â”‚
â”‚    íŒŒì¼: backend/rag/embeddings.py:30                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ChromaDB ë²¡í„° ê²€ìƒ‰                                        â”‚
â”‚    - ì½”ì‚¬ì¸ ìœ ì‚¬ë„ë¡œ top_k=3ê°œ í›„ë³´ ê²€ìƒ‰                    â”‚
â”‚    - ì „ì²´ 74ê°œ ì²­í¬ ì¤‘ ê°€ì¥ ìœ ì‚¬í•œ 3ê°œ ì„ íƒ                 â”‚
â”‚    íŒŒì¼: backend/rag/vector_store.py:50                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Distance ê³„ì‚° ê²°ê³¼ (ChromaDBê°€ ë°˜í™˜)                     â”‚
â”‚    ë¬¸ì„œ1: distance = 0.35  (cafe_startup_tips.txt)          â”‚
â”‚    ë¬¸ì„œ2: distance = 0.42  (location_analysis_method.txt)   â”‚
â”‚    ë¬¸ì„œ3: distance = 0.68  (startup_guide.txt)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ğŸ¯ ì„ê³„ê°’ í•„í„°ë§ (í•µì‹¬ ë¡œì§!)                            â”‚
â”‚    ê¸°ì¤€: distance <= 0.5                                     â”‚
â”‚                                                              â”‚
â”‚    ë¬¸ì„œ1: 0.35 <= 0.5 âœ… í†µê³¼ (ìœ ì‚¬ë„ 82.5%)               â”‚
â”‚    ë¬¸ì„œ2: 0.42 <= 0.5 âœ… í†µê³¼ (ìœ ì‚¬ë„ 79%)                 â”‚
â”‚    ë¬¸ì„œ3: 0.68 <= 0.5 âŒ í•„í„°ë§ (ìœ ì‚¬ë„ 66%)               â”‚
â”‚                                                              â”‚
â”‚    ìµœì¢… ê²°ê³¼: 2ê°œ ë¬¸ì„œ ë°˜í™˜                                 â”‚
â”‚    íŒŒì¼: backend/rag/retriever.py:105                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. RAGChain.run() ì²˜ë¦¬                                       â”‚
â”‚    - ë¬¸ì„œ ìˆìŒ (2ê°œ) â†’ LLM í˜¸ì¶œ                             â”‚
â”‚    - ë¬¸ì„œ ì—†ìŒ (0ê°œ) â†’ "ê´€ë ¨ ì •ë³´ ì—†ìŒ" ì¦‰ì‹œ ì‘ë‹µ          â”‚
â”‚    íŒŒì¼: backend/rag/rag_chain.py:109                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. í”„ë¡ íŠ¸ì—”ë“œ í‘œì‹œ                                          â”‚
â”‚    - AI ë‹µë³€ + ì°¸ê³  ë¬¸ì„œ 2ê°œ ì¶œì²˜ í‘œì‹œ                      â”‚
â”‚    íŒŒì¼: components/Chatbot.tsx:472                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## í•µì‹¬ ê°œë…: Distance vs Similarity

### ChromaDBì˜ Cosine Distance

ChromaDBëŠ” **ì½”ì‚¬ì¸ ê±°ë¦¬(Cosine Distance)**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:

```
Distance = 1 - Cosine Similarity
```

**ì¤‘ìš”í•œ íŠ¹ì„±:**
- Distance ê°’ ë²”ìœ„: `0.0 ~ 2.0`
- **Distanceê°€ ë‚®ì„ìˆ˜ë¡ ìœ ì‚¬**í•¨ (ê±°ë¦¬ê°€ ê°€ê¹Œì›€)
- **Distanceê°€ ë†’ì„ìˆ˜ë¡ ë‹¤ë¦„** (ê±°ë¦¬ê°€ ë©ˆ)

### Distance â†’ Similarity ë³€í™˜ ê³µì‹

ì½”ë“œì—ì„œ ì‚¬ìš©í•˜ëŠ” ë³€í™˜ ê³µì‹ (retriever.py:102):

```python
similarity_score = 1 - (distance / 2)
```

#### ğŸ¯ ê³µì‹ ì‰¬ìš´ ì„¤ëª…

**ì™œ í•„ìš”í•œê°€?**
- ChromaDBëŠ” **distance**(ê±°ë¦¬)ë¥¼ ë°˜í™˜: "ì–¼ë§ˆë‚˜ ë©€ë¦¬ ë–¨ì–´ì ¸ ìˆë‚˜?"
- ìš°ë¦¬ê°€ ì›í•˜ëŠ” ê±´ **similarity**(ìœ ì‚¬ë„): "ì–¼ë§ˆë‚˜ ë¹„ìŠ·í•œê°€?"
- DistanceëŠ” ë‚®ì„ìˆ˜ë¡ ì¢‹ê³ , SimilarityëŠ” ë†’ì„ìˆ˜ë¡ ì¢‹ìŒ (ì •ë°˜ëŒ€!)

**ê³µì‹ì„ ë‘ ë‹¨ê³„ë¡œ ë¶„í•´:**

**Step 1: `distance / 2`** - Distanceë¥¼ 0~1 ë²”ìœ„ë¡œ ì••ì¶•
```python
ì›ë˜ Distance:  0.0 ~ 2.0
     â†“ (ë‚˜ëˆ„ê¸° 2)
ì••ì¶•ëœ ê°’:      0.0 ~ 1.0

ì˜ˆì‹œ:
distance = 0.0  â†’  0.0 / 2 = 0.0
distance = 0.5  â†’  0.5 / 2 = 0.25
distance = 1.0  â†’  1.0 / 2 = 0.5
distance = 2.0  â†’  2.0 / 2 = 1.0
```

**Step 2: `1 - (ê°’)`** - ë°˜ì „ì‹œí‚¤ê¸° (ê±°ë¦¬ â†’ ìœ ì‚¬ë„)
```python
ì••ì¶•ëœ ê°’:   0.0 ~ 1.0
   â†“ (1ì—ì„œ ë¹¼ê¸°)
Similarity:  1.0 ~ 0.0

ì˜ˆì‹œ:
1 - 0.0 = 1.0  (100% ìœ ì‚¬)
1 - 0.25 = 0.75 (75% ìœ ì‚¬)
1 - 0.5 = 0.5  (50% ìœ ì‚¬)
1 - 1.0 = 0.0  (0% ìœ ì‚¬)
```

**í•œ ì¤„ ìš”ì•½:**
> "ChromaDBì˜ ê±°ë¦¬(0~2)ë¥¼ ì ˆë°˜ìœ¼ë¡œ ì¤„ì´ê³ (0~1), 1ì—ì„œ ë¹¼ì„œ ë’¤ì§‘ìœ¼ë©´(1~0), ìœ ì‚¬ë„ ì ìˆ˜(100%~0%)ê°€ ëœë‹¤"

**ì‹¤ì „ ì˜ˆì‹œ:**
```python
ë¬¸ì„œ1: distance = 0.3
  Step 1: 0.3 / 2 = 0.15
  Step 2: 1 - 0.15 = 0.85
  â†’ similarity = 85% âœ…

ë¬¸ì„œ2: distance = 0.8
  Step 1: 0.8 / 2 = 0.4
  Step 2: 1 - 0.4 = 0.6
  â†’ similarity = 60% ğŸ¤·

ë¬¸ì„œ3: distance = 1.4
  Step 1: 1.4 / 2 = 0.7
  Step 2: 1 - 0.7 = 0.3
  â†’ similarity = 30% âŒ
```

### Distance-Similarity ëŒ€ì‘í‘œ

| Distance | Similarity Score | ì˜ë¯¸ | ì˜ˆì‹œ |
|----------|------------------|------|------|
| **0.0** | **100%** | ì™„ì „ ì¼ì¹˜ | ë™ì¼í•œ ë¬¸ì¥ |
| **0.1** | **95%** | ê±°ì˜ ë™ì¼ | ë¬¸ì¥ ìˆœì„œë§Œ ë‹¤ë¦„ |
| **0.2** | **90%** | ë§¤ìš° ìœ ì‚¬ | ê°™ì€ ì£¼ì œ, ë¹„ìŠ·í•œ í‘œí˜„ |
| **0.3** | **85%** | ìƒë‹¹íˆ ìœ ì‚¬ | ê°™ì€ ì£¼ì œ, ë‹¤ë¥¸ í‘œí˜„ |
| **0.4** | **80%** | ìœ ì‚¬ | ê´€ë ¨ ì£¼ì œ |
| **0.5** | **75%** | ğŸ¯ **ì„ê³„ê°’** | **í•„í„°ë§ ê²½ê³„ì„ ** |
| **0.6** | **70%** | ë³´í†µ ê´€ë ¨ | ì•½ê°„ ë‹¤ë¥¸ ì£¼ì œ |
| **0.7** | **65%** | ì•½ê°„ ê´€ë ¨ | ê°™ì€ ì¹´í…Œê³ ë¦¬ |
| **0.8** | **60%** | ê±°ì˜ ë¬´ê´€ | í‚¤ì›Œë“œë§Œ ì¼ë¶€ ê²¹ì¹¨ |
| **1.0** | **50%** | ë¬´ê´€ | ì™„ì „íˆ ë‹¤ë¥¸ ì£¼ì œ |
| **2.0** | **0%** | ì™„ì „ ë°˜ëŒ€ | ì •ë°˜ëŒ€ ì˜ë¯¸ |

### ì‹œê°ì  ë¹„êµ

```
Distance Scale (ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ):
0.0 â”â”â”â”â” 0.5 â”â”â”â”â” 1.0 â”â”â”â”â” 2.0
ì™„ë²½      ì„ê³„ê°’     ë¬´ê´€       ë°˜ëŒ€
    âœ… í†µê³¼   |   âŒ í•„í„°ë§

Similarity Scale (ë†’ì„ìˆ˜ë¡ ì¢‹ìŒ):
100% â”â”â”â”â” 75% â”â”â”â”â” 50% â”â”â”â”â” 0%
ì™„ë²½      ì„ê³„ê°’     ë¬´ê´€      ë°˜ëŒ€
    âœ… í†µê³¼   |   âŒ í•„í„°ë§
```

---

## ì„ê³„ê°’ í•„í„°ë§ ë¡œì§

### âš ï¸ ì¤‘ìš”: score_thresholdì˜ ì˜ë¯¸

**í”í•œ ì˜¤í•´:**
```python
score_threshold: float = 0.5
```

ë§ì€ ì‚¬ëŒë“¤ì´ ì´ë ‡ê²Œ ìƒê°í•©ë‹ˆë‹¤:
- âŒ "ìœ ì‚¬ë„ 50% ì´ìƒë§Œ í—ˆìš©í•œë‹¤"
- âŒ "50% ë¯¸ë§Œì´ë©´ í•„í„°ë§í•œë‹¤"

**ì •í™•í•œ ì˜ë¯¸:**
```python
score_threshold: float = 0.5  # ì´ê²ƒì€ Distance ê¸°ì¤€!
```

ì‹¤ì œë¡œëŠ”:
- âœ… **"Distance 0.5 ì´í•˜ë§Œ í—ˆìš©í•œë‹¤"**
- âœ… **"ìœ ì‚¬ë„ 75% ì´ìƒë§Œ í—ˆìš©í•œë‹¤"**

**ì™œ í—·ê°ˆë¦´ê¹Œ?**
- ë³€ìˆ˜ ì´ë¦„ì´ `score_threshold`ë¼ì„œ "ì ìˆ˜(ìœ ì‚¬ë„) ê¸°ì¤€"ìœ¼ë¡œ ì˜¤í•´
- ì‹¤ì œë¡œëŠ” **"Distance ì„ê³„ê°’"**
- ë” ì •í™•í•œ ì´ë¦„ì€ `distance_threshold`ì˜€ì„ ê²ƒ

**ë³€í™˜ ê³„ì‚°:**
```python
threshold (Distance) = 0.5
     â†“
similarity = 1 - (0.5 / 2)
similarity = 1 - 0.25
similarity = 0.75
similarity = 75%

ë”°ë¼ì„œ:
threshold = 0.5 (Distance)
         = 75% (Similarity)
```

### ì„¤ì • ìœ„ì¹˜

**íŒŒì¼:** `backend/rag/retriever.py`

```python
class Retriever:
    def __init__(
        self,
        embeddings: BGEEmbeddings = None,
        vector_store: ChromaVectorStore = None,
        top_k: int = 3,                    # ìµœëŒ€ 3ê°œ ê²€ìƒ‰
        score_threshold: float = 0.5       # ğŸ¯ Distance ì„ê³„ê°’: 0.5
                                            #    = ìœ ì‚¬ë„ 75% ì´ìƒ
    ):
```

**ì‹¤ì œ ë™ì‘:**
```python
# í•„í„°ë§ ì¡°ê±´ (retriever.py:105)
if distance <= self.score_threshold:
    # distanceì™€ ë¹„êµ â†’ Distance ê¸°ì¤€ì„ì„ ì¦ëª…!
    formatted_results.append(ë¬¸ì„œ)
```

### í•„í„°ë§ ì½”ë“œ (retriever.py:104-113)

```python
# ê²°ê³¼ í¬ë§·íŒ… ë° í•„í„°ë§
formatted_results = []
for i, (doc, metadata, distance, doc_id) in enumerate(zip(
    results["documents"],
    results["metadatas"],
    results["distances"],
    results["ids"]
)):
    # ìœ ì‚¬ë„ ì ìˆ˜ ê³„ì‚°
    similarity_score = 1 - (distance / 2)

    # ğŸ¯ ì„ê³„ê°’ í•„í„°ë§ - í•µì‹¬ ë¡œì§!
    if distance <= self.score_threshold or self.score_threshold <= 0:
        formatted_results.append({
            "content": doc,
            "metadata": metadata,
            "score": round(similarity_score, 4),  # í”„ë¡ íŠ¸ì—”ë“œ í‘œì‹œìš©
            "distance": round(distance, 4),
            "id": doc_id,
            "rank": i + 1
        })
```

### í•„í„°ë§ ì¡°ê±´ ë¶„ì„

```python
if distance <= self.score_threshold or self.score_threshold <= 0:
```

ì´ ì¡°ê±´ì€ ë‘ ê°€ì§€ ê²½ìš°ì— í†µê³¼:

1. **`distance <= 0.5`**: Distanceê°€ ì„ê³„ê°’ ì´í•˜ (ì¶©ë¶„íˆ ìœ ì‚¬)
2. **`score_threshold <= 0`**: ì„ê³„ê°’ì´ 0 ì´í•˜ (í•„í„°ë§ ë¹„í™œì„±í™”)

### í•„í„°ë§ ì˜ˆì‹œ

**ì‹œë‚˜ë¦¬ì˜¤: "ê°•ë‚¨ ì¹´í˜ ì°½ì—…" ê²€ìƒ‰**

ChromaDBê°€ ë°˜í™˜í•œ top_k=3 í›„ë³´:

```python
ë¬¸ì„œ1: "ê°•ë‚¨ ìƒê¶Œ ë¶„ì„ ê°€ì´ë“œ"       â†’ distance = 0.28 (ìœ ì‚¬ë„ 86%)
ë¬¸ì„œ2: "ì¹´í˜ ì°½ì—… ì²´í¬ë¦¬ìŠ¤íŠ¸"       â†’ distance = 0.45 (ìœ ì‚¬ë„ 77.5%)
ë¬¸ì„œ3: "ì¼ë°˜ ì°½ì—… ì ˆì°¨"             â†’ distance = 0.62 (ìœ ì‚¬ë„ 69%)
```

í•„í„°ë§ ê³¼ì • (threshold = 0.5 = ìœ ì‚¬ë„ 75% ê¸°ì¤€):

```python
# ë¬¸ì„œ1 ê²€ì‚¬
if 0.28 <= 0.5:  # True
    # distance 0.28 = ìœ ì‚¬ë„ 86% â†’ 75% ì´ìƒ âœ…
    formatted_results.append(ë¬¸ì„œ1)  # âœ… í†µê³¼

# ë¬¸ì„œ2 ê²€ì‚¬
if 0.45 <= 0.5:  # True
    # distance 0.45 = ìœ ì‚¬ë„ 77.5% â†’ 75% ì´ìƒ âœ…
    formatted_results.append(ë¬¸ì„œ2)  # âœ… í†µê³¼

# ë¬¸ì„œ3 ê²€ì‚¬
if 0.62 <= 0.5:  # False
    # distance 0.62 = ìœ ì‚¬ë„ 69% â†’ 75% ë¯¸ë§Œ âŒ
    # âŒ í•„í„°ë§ - ì¶”ê°€í•˜ì§€ ì•ŠìŒ
```

**ìµœì¢… ê²°ê³¼:**
- `formatted_results = [ë¬¸ì„œ1, ë¬¸ì„œ2]` (2ê°œ)
- ì‚¬ìš©ìì—ê²ŒëŠ” 2ê°œ ì¶œì²˜ í‘œì‹œ
- ë¬¸ì„œ3ì€ 69% ìœ ì‚¬ë„ì¸ë°ë„ 75% ê¸°ì¤€ì— ëª» ë¯¸ì³ íƒˆë½

---

## ê²€ìƒ‰ ê²°ê³¼ 0ê±´ì´ ë°œìƒí•˜ëŠ” ì´ìœ 

### Case 1: ë¬¸ì„œì— ì—†ëŠ” ì£¼ì œ

**ì˜ˆì‹œ:**

```python
ì§ˆë¬¸: "ì¼ë³¸ì—ì„œ ì°½ì—…í•˜ë ¤ë©´ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?"

# ChromaDB ê²€ìƒ‰ ê²°ê³¼
ë¬¸ì„œ1: "ì„œìš¸ì‹œ ì°½ì—… ê°€ì´ë“œ"         â†’ distance = 0.75 (ìœ ì‚¬ë„ 62.5%)
ë¬¸ì„œ2: "í•œêµ­ ìƒê¶Œ ë¶„ì„"             â†’ distance = 0.82 (ìœ ì‚¬ë„ 59%)
ë¬¸ì„œ3: "ì†Œìƒê³µì¸ ì§€ì› ì •ì±…"         â†’ distance = 0.68 (ìœ ì‚¬ë„ 66%)

# í•„í„°ë§
if 0.75 <= 0.5:  # False âŒ
if 0.82 <= 0.5:  # False âŒ
if 0.68 <= 0.5:  # False âŒ

# ê²°ê³¼
formatted_results = []  # 0ê°œ!
```

**ì™œ í•„í„°ë§ ë˜ì—ˆë‚˜?**
- ëª¨ë“  ë¬¸ì„œê°€ "í•œêµ­", "ì„œìš¸" ì¤‘ì‹¬
- "ì¼ë³¸" ê´€ë ¨ ë‚´ìš© ì—†ìŒ
- ì„ë² ë”© ë²¡í„°ê°€ ë„ˆë¬´ ë‹¤ë¦„
- Distance > 0.5 â†’ ëª¨ë‘ í•„í„°ë§

### Case 2: ë„ˆë¬´ ì¶”ìƒì /ëª¨í˜¸í•œ ì§ˆë¬¸

**ì˜ˆì‹œ:**

```python
ì§ˆë¬¸: "ì„±ê³µí•˜ëŠ” ë°©ë²•ì€?"

# ChromaDB ê²€ìƒ‰ ê²°ê³¼
ë¬¸ì„œ1: "ì¹´í˜ ì°½ì—… ë¹„ìš© ê°€ì´ë“œ"      â†’ distance = 0.88 (ìœ ì‚¬ë„ 56%)
ë¬¸ì„œ2: "ìƒê¶Œ ë¶„ì„ ë°©ë²•ë¡ "           â†’ distance = 0.91 (ìœ ì‚¬ë„ 54.5%)
ë¬¸ì„œ3: "ì°½ì—… ì ˆì°¨ ì•ˆë‚´"             â†’ distance = 0.79 (ìœ ì‚¬ë„ 60.5%)

# ê²°ê³¼
formatted_results = []  # 0ê°œ!
```

**ì™œ í•„í„°ë§ ë˜ì—ˆë‚˜?**
- "ì„±ê³µ" í‚¤ì›Œë“œê°€ ë„ˆë¬´ ê´‘ë²”ìœ„
- êµ¬ì²´ì ì¸ ë§¥ë½ ì—†ìŒ (ì¹´í˜? ìƒê¶Œ? ë¬´ì—‡ì„?)
- ëª¨ë“  ë¬¸ì„œê°€ êµ¬ì²´ì  ë‚´ìš© (ë¹„ìš©, ì ˆì°¨ ë“±)
- ì˜ë¯¸ì  ê±°ë¦¬ê°€ ë©ˆ

### Case 3: ë‹¨ì–´ëŠ” ë¹„ìŠ·í•˜ì§€ë§Œ ë§¥ë½ì´ ë‹¤ë¦„

**ì˜ˆì‹œ:**

```python
ì§ˆë¬¸: "ë°°ë‹¬ ì•± í”Œë«í¼ì„ ë§Œë“¤ê³  ì‹¶ì–´ìš”"

# ChromaDB ê²€ìƒ‰ ê²°ê³¼
ë¬¸ì„œ1: "ì¹´í˜ ë°°ë‹¬ ì„œë¹„ìŠ¤ íŒ"        â†’ distance = 0.58 (ìœ ì‚¬ë„ 71%)
ë¬¸ì„œ2: "ì˜¨ë¼ì¸ ë§ˆì¼€íŒ… ì „ëµ"         â†’ distance = 0.64 (ìœ ì‚¬ë„ 68%)
ë¬¸ì„œ3: "í”Œë«í¼ ë¹„ì¦ˆë‹ˆìŠ¤ ì†Œê°œ"       â†’ distance = 0.52 (ìœ ì‚¬ë„ 74%)

# í•„í„°ë§
if 0.58 <= 0.5:  # False âŒ
if 0.64 <= 0.5:  # False âŒ
if 0.52 <= 0.5:  # False âŒ

# ê²°ê³¼
formatted_results = []  # 0ê°œ!
```

**ì™œ í•„í„°ë§ ë˜ì—ˆë‚˜?**
- "ë°°ë‹¬", "í”Œë«í¼" í‚¤ì›Œë“œëŠ” ì¼ë¶€ ê²¹ì¹¨
- í•˜ì§€ë§Œ ì§ˆë¬¸ì€ "IT ê°œë°œ", ë¬¸ì„œëŠ” "ì˜¤í”„ë¼ì¸ ì°½ì—…"
- ë§¥ë½ì´ ì™„ì „íˆ ë‹¤ë¦„
- Distanceê°€ 0.5 ê·¼ì²˜ì§€ë§Œ ëª¨ë‘ ì´ˆê³¼

### 0ê±´ì¼ ë•Œ ì‹œìŠ¤í…œ ì‘ë‹µ

**íŒŒì¼:** `backend/rag/rag_chain.py:52-57`

```python
# RAGChain.run() ë©”ì„œë“œ ë‚´ë¶€
retrieved_docs = self.retriever.search(query, top_k=top_k)

# ğŸ¯ ê²€ìƒ‰ ê²°ê³¼ 0ê±´ ì²´í¬
if not retrieved_docs:
    return {
        "answer": "ì£„ì†¡í•©ë‹ˆë‹¤. ê´€ë ¨ëœ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì§ˆë¬¸ì„ í•´ì£¼ì‹œê² ì–´ìš”?",
        "sources": [],
        "query": query
    }
```

**íŠ¹ì§•:**
- **LLM í˜¸ì¶œ ì•ˆ í•¨** (í† í° ì ˆì•½)
- ì¦‰ì‹œ ê³ ì •ëœ ë©”ì‹œì§€ ë°˜í™˜
- `sources = []` â†’ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì¶œì²˜ í‘œì‹œ ì•ˆ ë¨

---

## ì‹¤ì œ ì½”ë“œ ë¶„ì„

### 1. Retriever ì´ˆê¸°í™”

**íŒŒì¼:** `backend/rag/retriever.py:16-47`

```python
class Retriever:
    def __init__(
        self,
        embeddings: BGEEmbeddings = None,
        vector_store: ChromaVectorStore = None,
        top_k: int = 3,                      # ê²€ìƒ‰í•  ìµœëŒ€ ë¬¸ì„œ ê°œìˆ˜
        score_threshold: float = 0.5         # Distance ì„ê³„ê°’
    ):
        # ì„ë² ë”© ëª¨ë¸ ì´ˆê¸°í™”
        if embeddings is None:
            self.embeddings = BGEEmbeddings()  # BGE-M3-KO
        else:
            self.embeddings = embeddings

        # ë²¡í„° ìŠ¤í† ì–´ ì´ˆê¸°í™”
        if vector_store is None:
            self.vector_store = ChromaVectorStore()  # ChromaDB
        else:
            self.vector_store = vector_store

        self.top_k = top_k
        self.score_threshold = score_threshold
```

### 2. ê²€ìƒ‰ ë©”ì„œë“œ

**íŒŒì¼:** `backend/rag/retriever.py:49-116`

```python
def search(
    self,
    query: str,
    top_k: Optional[int] = None,
    filter_metadata: Optional[Dict[str, Any]] = None
) -> List[Dict[str, Any]]:

    # 1ï¸âƒ£ ì…ë ¥ ê²€ì¦
    if not query or not query.strip():
        raise ValueError("ê²€ìƒ‰ ì¿¼ë¦¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")

    # 2ï¸âƒ£ top_k ì„¤ì •
    k = top_k if top_k is not None else self.top_k

    # 3ï¸âƒ£ ì¿¼ë¦¬ ì„ë² ë”© (ë¬¸ìì—´ â†’ ë²¡í„°)
    print(f"[SEARCH] ê²€ìƒ‰ ì¿¼ë¦¬: {query}")
    query_embedding = self.embeddings.embed_query(query)
    # ê²°ê³¼: [0.23, -0.45, 0.78, ..., 0.12] (1024ì°¨ì›)

    # 4ï¸âƒ£ ë²¡í„° ê²€ìƒ‰
    results = self.vector_store.search(
        query_embedding=query_embedding,
        top_k=k,
        filter_metadata=filter_metadata
    )
    # ChromaDBê°€ ì½”ì‚¬ì¸ ê±°ë¦¬ ê¸°ì¤€ìœ¼ë¡œ top_kê°œ ë°˜í™˜

    # 5ï¸âƒ£ ê²°ê³¼ í¬ë§·íŒ… ë° í•„í„°ë§
    formatted_results = []
    for i, (doc, metadata, distance, doc_id) in enumerate(zip(
        results["documents"],    # ë¬¸ì„œ ë‚´ìš©
        results["metadatas"],    # ë©”íƒ€ë°ì´í„° (ì¶œì²˜ ë“±)
        results["distances"],    # Distance ê°’
        results["ids"]           # ë¬¸ì„œ ID
    )):
        # Distance â†’ Similarity ë³€í™˜
        similarity_score = 1 - (distance / 2)

        # ğŸ¯ ì„ê³„ê°’ í•„í„°ë§
        if distance <= self.score_threshold or self.score_threshold <= 0:
            formatted_results.append({
                "content": doc,
                "metadata": metadata,
                "score": round(similarity_score, 4),
                "distance": round(distance, 4),
                "id": doc_id,
                "rank": i + 1
            })

    print(f"[OK] {len(formatted_results)}ê°œ ë¬¸ì„œ ê²€ìƒ‰ ì™„ë£Œ")
    return formatted_results
```

### 3. RAGChain í†µí•©

**íŒŒì¼:** `backend/rag/rag_chain.py:109-145`

```python
def run(
    self,
    query: str,
    conversation_history: Optional[List[Dict[str, str]]] = None,
    top_k: int = 3
) -> Dict[str, Any]:

    print(f"\n[RAG] ì¿¼ë¦¬ ì²˜ë¦¬ ì‹œì‘: {query}")

    # 1ï¸âƒ£ ë¬¸ì„œ ê²€ìƒ‰
    retrieved_docs = self.retriever.search(query, top_k=top_k)

    # 2ï¸âƒ£ ê²€ìƒ‰ ê²°ê³¼ 0ê±´ ì²´í¬
    if not retrieved_docs:
        print("[WARNING] ê´€ë ¨ ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return {
            "answer": "ì£„ì†¡í•©ë‹ˆë‹¤. ê´€ë ¨ëœ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì§ˆë¬¸ì„ í•´ì£¼ì‹œê² ì–´ìš”?",
            "sources": [],
            "query": query
        }

    # 3ï¸âƒ£ ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ LLM í˜¸ì¶œ
    print(f"[OK] {len(retrieved_docs)}ê°œ ë¬¸ì„œ ê²€ìƒ‰ë¨")

    # í”„ë¡¬í”„íŠ¸ ìƒì„±
    messages = self.create_prompt(query, retrieved_docs, conversation_history)

    # OpenAI API í˜¸ì¶œ
    response = self.client.chat.completions.create(
        model=self.model_name,
        messages=messages,
        temperature=self.temperature,
        max_tokens=self.max_tokens
    )

    # 4ï¸âƒ£ ì‘ë‹µ ë°˜í™˜
    return {
        "answer": response.choices[0].message.content,
        "sources": retrieved_docs,
        "query": query,
        "usage": {
            "prompt_tokens": response.usage.prompt_tokens,
            "completion_tokens": response.usage.completion_tokens,
            "total_tokens": response.usage.total_tokens
        }
    }
```

---

## ì‹¤ì „ ì˜ˆì‹œ

### ì˜ˆì‹œ 1: ê²€ìƒ‰ ì„±ê³µ (2ê°œ ë¬¸ì„œ)

**ì§ˆë¬¸:**
```
"ê°•ë‚¨ì—ì„œ ì¹´í˜ ì°½ì—…í•˜ë ¤ë©´ ì´ˆê¸° ë¹„ìš©ì´ ì–¼ë§ˆë‚˜ í•„ìš”í•´?"
```

**ì²˜ë¦¬ ê³¼ì •:**

```python
# 1. ì¿¼ë¦¬ ì„ë² ë”©
query_embedding = [0.12, -0.34, 0.56, ..., 0.89]  # 1024ì°¨ì›

# 2. ChromaDB ê²€ìƒ‰ (top_k=3)
ChromaDBê°€ ë°˜í™˜í•œ í›„ë³´:
  ë¬¸ì„œ1: cafe_startup_tips.txt, chunk 5
    ë‚´ìš©: "ê°•ë‚¨ ì§€ì—­ì˜ ì¹´í˜ ì°½ì—… ì‹œ í‰ê·  ì´ˆê¸° ë¹„ìš©ì€..."
    distance: 0.23

  ë¬¸ì„œ2: location_analysis_method.txt, chunk 12
    ë‚´ìš©: "ìƒê¶Œ ë¶„ì„ ì‹œ ê³ ë ¤í•´ì•¼ í•  ì´ˆê¸° íˆ¬ì ë¹„ìš©..."
    distance: 0.41

  ë¬¸ì„œ3: startup_guide.txt, chunk 3
    ë‚´ìš©: "ì¼ë°˜ì ì¸ ì°½ì—… ì ˆì°¨ì™€ ì¤€ë¹„ì‚¬í•­..."
    distance: 0.58

# 3. í•„í„°ë§ (threshold = 0.5)
ë¬¸ì„œ1: 0.23 <= 0.5 âœ… í†µê³¼ (ìœ ì‚¬ë„ 88.5%)
ë¬¸ì„œ2: 0.41 <= 0.5 âœ… í†µê³¼ (ìœ ì‚¬ë„ 79.5%)
ë¬¸ì„œ3: 0.58 <= 0.5 âŒ í•„í„°ë§ (ìœ ì‚¬ë„ 71%)

# 4. ìµœì¢… ê²°ê³¼
formatted_results = [
    {
        "content": "ê°•ë‚¨ ì§€ì—­ì˜ ì¹´í˜ ì°½ì—… ì‹œ í‰ê·  ì´ˆê¸° ë¹„ìš©ì€...",
        "metadata": {"source": "cafe_startup_tips.txt", "chunk": 5},
        "score": 0.885,
        "distance": 0.23,
        "rank": 1
    },
    {
        "content": "ìƒê¶Œ ë¶„ì„ ì‹œ ê³ ë ¤í•´ì•¼ í•  ì´ˆê¸° íˆ¬ì ë¹„ìš©...",
        "metadata": {"source": "location_analysis_method.txt", "chunk": 12},
        "score": 0.795,
        "distance": 0.41,
        "rank": 2
    }
]

# 5. RAGChain ì²˜ë¦¬
retrieved_docsê°€ 2ê°œ â†’ LLM í˜¸ì¶œ âœ…

# 6. LLMì— ì „ë‹¬ë˜ëŠ” í”„ë¡¬í”„íŠ¸
"""
[ì°¸ê³  ë¬¸ì„œ]
[ë¬¸ì„œ 1] (ìœ ì‚¬ë„: 0.89)
ì¶œì²˜: cafe_startup_tips.txt
ê°•ë‚¨ ì§€ì—­ì˜ ì¹´í˜ ì°½ì—… ì‹œ í‰ê·  ì´ˆê¸° ë¹„ìš©ì€...

---

[ë¬¸ì„œ 2] (ìœ ì‚¬ë„: 0.80)
ì¶œì²˜: location_analysis_method.txt
ìƒê¶Œ ë¶„ì„ ì‹œ ê³ ë ¤í•´ì•¼ í•  ì´ˆê¸° íˆ¬ì ë¹„ìš©...

[ì‚¬ìš©ì ì§ˆë¬¸]
ê°•ë‚¨ì—ì„œ ì¹´í˜ ì°½ì—…í•˜ë ¤ë©´ ì´ˆê¸° ë¹„ìš©ì´ ì–¼ë§ˆë‚˜ í•„ìš”í•´?

ìœ„ ì°¸ê³  ë¬¸ì„œë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”.
"""

# 7. LLM ì‘ë‹µ
"ê°•ë‚¨ì—ì„œ ì¹´í˜ë¥¼ ì°½ì—…í•˜ì‹œë ¤ë©´ í‰ê· ì ìœ¼ë¡œ 1ì–µ 5ì²œë§Œì›~2ì–µì› ì •ë„ì˜
ì´ˆê¸° ë¹„ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤. ì—¬ê¸°ì—ëŠ” ë³´ì¦ê¸ˆ, ì¸í…Œë¦¬ì–´, ì¥ë¹„ êµ¬ì…ë¹„ ë“±ì´
í¬í•¨ë©ë‹ˆë‹¤..."

# 8. í”„ë¡ íŠ¸ì—”ë“œ í‘œì‹œ
AI ë©”ì‹œì§€: "ê°•ë‚¨ì—ì„œ ì¹´í˜ë¥¼ ì°½ì—…í•˜ì‹œë ¤ë©´..."
ì°¸ê³  ë¬¸ì„œ:
  - cafe_startup_tips.txt (ìœ ì‚¬ë„ 88.5%)
  - location_analysis_method.txt (ìœ ì‚¬ë„ 79.5%)
```

### ì˜ˆì‹œ 2: ê²€ìƒ‰ ì‹¤íŒ¨ (0ê°œ ë¬¸ì„œ)

**ì§ˆë¬¸:**
```
"ì¼ë³¸ì—ì„œ ë¼ë©˜ì§‘ ì°¨ë¦¬ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í•´?"
```

**ì²˜ë¦¬ ê³¼ì •:**

```python
# 1. ì¿¼ë¦¬ ì„ë² ë”©
query_embedding = [0.45, -0.12, 0.33, ..., 0.67]

# 2. ChromaDB ê²€ìƒ‰ (top_k=3)
ChromaDBê°€ ë°˜í™˜í•œ í›„ë³´:
  ë¬¸ì„œ1: startup_guide.txt, chunk 8
    ë‚´ìš©: "ì°½ì—… ì‹œ í•„ìš”í•œ ê¸°ë³¸ ì„œë¥˜..."
    distance: 0.78  (í‚¤ì›Œë“œ 'ì°½ì—…'ë§Œ ê²¹ì¹¨)

  ë¬¸ì„œ2: cafe_startup_tips.txt, chunk 2
    ë‚´ìš©: "ì„œìš¸ ê°•ë‚¨ ìƒê¶Œ ë¶„ì„..."
    distance: 0.82  ('ìƒê¶Œ'ë§Œ ì•½ê°„ ê´€ë ¨)

  ë¬¸ì„œ3: location_analysis_method.txt, chunk 1
    ë‚´ìš©: "êµ­ë‚´ ìƒê¶Œ ë¶„ì„ ë°©ë²•ë¡ ..."
    distance: 0.71  ('ë¶„ì„'ë§Œ ê´€ë ¨)

# 3. í•„í„°ë§ (threshold = 0.5)
ë¬¸ì„œ1: 0.78 <= 0.5 âŒ (ìœ ì‚¬ë„ 61%)
ë¬¸ì„œ2: 0.82 <= 0.5 âŒ (ìœ ì‚¬ë„ 59%)
ë¬¸ì„œ3: 0.71 <= 0.5 âŒ (ìœ ì‚¬ë„ 64.5%)

# 4. ìµœì¢… ê²°ê³¼
formatted_results = []  # 0ê°œ!

# 5. RAGChain ì²˜ë¦¬
retrieved_docsê°€ 0ê°œ â†’ LLM í˜¸ì¶œ ì•ˆ í•¨ âŒ
ì¦‰ì‹œ ê³ ì • ë©”ì‹œì§€ ë°˜í™˜:
{
    "answer": "ì£„ì†¡í•©ë‹ˆë‹¤. ê´€ë ¨ëœ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì§ˆë¬¸ì„ í•´ì£¼ì‹œê² ì–´ìš”?",
    "sources": [],
    "query": "ì¼ë³¸ì—ì„œ ë¼ë©˜ì§‘ ì°¨ë¦¬ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í•´?"
}

# 6. í”„ë¡ íŠ¸ì—”ë“œ í‘œì‹œ
AI ë©”ì‹œì§€: "ì£„ì†¡í•©ë‹ˆë‹¤. ê´€ë ¨ëœ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤..."
ì°¸ê³  ë¬¸ì„œ: (í‘œì‹œ ì•ˆ ë¨)
```

**ì™œ ì‹¤íŒ¨í–ˆë‚˜?**
- ëª¨ë“  ë¬¸ì„œê°€ "í•œêµ­", "ì„œìš¸" ì¤‘ì‹¬
- "ì¼ë³¸", "ë¼ë©˜" ê´€ë ¨ ë‚´ìš© ì „í˜€ ì—†ìŒ
- ChromaDBê°€ ì°¾ì€ ë¬¸ì„œë“¤ë„ í‚¤ì›Œë“œë§Œ ì‚´ì§ ê²¹ì¹  ë¿
- Distanceê°€ ëª¨ë‘ 0.5 ì´ˆê³¼ â†’ ì „ë¶€ í•„í„°ë§

### ì˜ˆì‹œ 3: ê²½ê³„ì„  ì¼€ì´ìŠ¤ (1ê°œ ë¬¸ì„œ)

**ì§ˆë¬¸:**
```
"ì¹´í˜ ìš´ì˜í•  ë•Œ ì£¼ì˜í•  ì ì€?"
```

**ì²˜ë¦¬ ê³¼ì •:**

```python
# ChromaDB ê²€ìƒ‰ ê²°ê³¼
ë¬¸ì„œ1: cafe_startup_tips.txt, chunk 15
  ë‚´ìš©: "ì¹´í˜ ìš´ì˜ ì‹œ ë°˜ë“œì‹œ í™•ì¸í•´ì•¼ í•  ì²´í¬ë¦¬ìŠ¤íŠ¸..."
  distance: 0.32  âœ… (ìœ ì‚¬ë„ 84%)

ë¬¸ì„œ2: startup_guide.txt, chunk 6
  ë‚´ìš©: "ì‚¬ì—… ìš´ì˜ ì‹œ ë²•ì  ì£¼ì˜ì‚¬í•­..."
  distance: 0.49  âœ… (ìœ ì‚¬ë„ 75.5%)

ë¬¸ì„œ3: location_analysis_method.txt, chunk 20
  ë‚´ìš©: "ìƒê¶Œ ë¶„ì„ í›„ ë§¤ì¥ ê´€ë¦¬ íŒ..."
  distance: 0.51  âŒ (ìœ ì‚¬ë„ 74.5%)

# í•„í„°ë§
ë¬¸ì„œ1: 0.32 <= 0.5 âœ… í†µê³¼
ë¬¸ì„œ2: 0.49 <= 0.5 âœ… í†µê³¼ (ì•„ìŠ¬ì•„ìŠ¬!)
ë¬¸ì„œ3: 0.51 <= 0.5 âŒ í•„í„°ë§ (0.01 ì°¨ì´ë¡œ íƒˆë½!)

# ìµœì¢…: 2ê°œ ë¬¸ì„œ ë°˜í™˜
```

**ì¤‘ìš” í¬ì¸íŠ¸:**
- **0.49 vs 0.51**: ê²¨ìš° 0.02 ì°¨ì´ë¡œ ìš´ëª…ì´ ê°ˆë¦¼
- ë¬¸ì„œ3ë„ ì¶©ë¶„íˆ ê´€ë ¨ ìˆì§€ë§Œ ì„ê³„ê°’ ë•Œë¬¸ì— íƒˆë½
- ì´ëŸ° ê²½ê³„ì„  ì¼€ì´ìŠ¤ê°€ ì„ê³„ê°’ íŠœë‹ì´ ì¤‘ìš”í•œ ì´ìœ 

---

## íŠœë‹ ê°€ì´ë“œ

### í˜„ì¬ ì„¤ì • í‰ê°€

```python
score_threshold: float = 0.5  # Distance ê¸°ì¤€
                               # = ìœ ì‚¬ë„ 75% ì´ìƒë§Œ í—ˆìš©
                               # = ë§¤ìš° ì—„ê²©í•œ ê¸°ì¤€
```

**âš ï¸ ë‹¤ì‹œ í•œë²ˆ ê°•ì¡°:**
```
threshold = 0.5 (Distance)
         â‰  ìœ ì‚¬ë„ 50%
         = ìœ ì‚¬ë„ 75%!

ì¦‰, ìœ ì‚¬ë„ 75% ë¯¸ë§Œì´ë©´ ëª¨ë‘ ë²„ë¦½ë‹ˆë‹¤!
```

**ì¥ì :**
- âœ… ë¶€ì •í™•í•œ ë‹µë³€ ë°©ì§€
- âœ… í• ë£¨ì‹œë„¤ì´ì…˜ ê°ì†Œ
- âœ… ë†’ì€ ë‹µë³€ í’ˆì§ˆ

**ë‹¨ì :**
- âŒ ê²€ìƒ‰ ì‹¤íŒ¨ ë¹ˆë„ ë†’ìŒ
- âŒ ê´€ë ¨ ë¬¸ì„œ ìˆì–´ë„ ëª» ì°¾ìŒ (74% ìœ ì‚¬ë„ë„ íƒˆë½!)
- âŒ ì‚¬ìš©ì ê²½í—˜ ì €í•˜

### ì„ê³„ê°’ ì¡°ì • ê°€ì´ë“œ

**âš ï¸ ì£¼ì˜: ThresholdëŠ” Distance ê¸°ì¤€ì…ë‹ˆë‹¤!**

| Threshold (Distance) | ìœ ì‚¬ë„ ê¸°ì¤€ | ì¶”ì²œ ìš©ë„ | ì˜ˆìƒ íš¨ê³¼ |
|---------------------|------------|----------|----------|
| **0.3** | **85% ì´ìƒ** | ì „ë¬¸ ì˜ë£Œ, ë²•ë¥  | ê·¹ë„ë¡œ ì •í™•, ê²€ìƒ‰ ì‹¤íŒ¨ ë§ìŒ |
| **0.4** | **80% ì´ìƒ** | ê¸ˆìœµ, ê¸°ìˆ  ë¬¸ì„œ | ë§¤ìš° ì •í™•, ê²€ìƒ‰ ì‹¤íŒ¨ ìˆìŒ |
| **0.5** | **75% ì´ìƒ** | ğŸ¯ **í˜„ì¬ ì„¤ì •** | ì •í™•í•˜ì§€ë§Œ ì œí•œì  |
| **0.6** | **70% ì´ìƒ** | ì¼ë°˜ Q&A | ê· í˜•ì¡íŒ ì„¤ì • (ì¶”ì²œ) |
| **0.7** | **65% ì´ìƒ** | ìºì£¼ì–¼ ì±—ë´‡ | ê²€ìƒ‰ ì„±ê³µë¥  ë†’ìŒ |
| **0.8** | **60% ì´ìƒ** | ë¸Œë ˆì¸ìŠ¤í† ë° | ê´‘ë²”ìœ„í•œ ê²€ìƒ‰ |
| **1.0** | **50% ì´ìƒ** | íƒìƒ‰ì  ê²€ìƒ‰ | ë„ˆë¬´ ëŠìŠ¨í•¨ |

**ë³€í™˜ ê³µì‹ ì°¸ê³ :**
```
Threshold (Distance) â†’ Similarity
0.3 â†’ 1 - (0.3/2) = 0.85 = 85%
0.5 â†’ 1 - (0.5/2) = 0.75 = 75%
0.7 â†’ 1 - (0.7/2) = 0.65 = 65%
1.0 â†’ 1 - (1.0/2) = 0.5 = 50%
```

### ì¶”ì²œ ì„¤ì • ë³€ê²½

**ìƒí™©ë³„ ê¶Œì¥ ì„ê³„ê°’:**

#### 1. í˜„ì¬ í”„ë¡œì íŠ¸ (ì°½ì—…/ìƒê¶Œ ë¶„ì„)
```python
# ì¶”ì²œ: 0.6~0.7
score_threshold: float = 0.65

# ì´ìœ :
# - ì°½ì—… ê´€ë ¨ ì§ˆë¬¸ì€ ë‹¤ì–‘í•œ í‘œí˜„ ê°€ëŠ¥
# - "ì¹´í˜ ì°½ì—…", "ì»¤í”¼ìˆ ì˜¤í”ˆ", "ì¹´í˜ ì°¨ë¦¬ê¸°" â†’ ëª¨ë‘ ê°™ì€ ì˜ë¯¸
# - 70% ìœ ì‚¬ë„ë©´ ì¶©ë¶„íˆ ê´€ë ¨ì„± ìˆìŒ
# - ê²€ìƒ‰ ì„±ê³µë¥  í¬ê²Œ í–¥ìƒ
```

#### 2. ì—„ê²©í•œ ì •í™•ì„±ì´ í•„ìš”í•œ ê²½ìš°
```python
score_threshold: float = 0.4

# ì˜ˆ: ë²•ë¥  ìƒë‹´, ì˜ë£Œ ì •ë³´, ê·œì œ ì•ˆë‚´
# - ë¶€ì •í™•í•œ ì •ë³´ ì œê³µ ì‹œ í° ë¬¸ì œ
# - 80% ì´ìƒ ìœ ì‚¬ë„ ìš”êµ¬
```

#### 3. íƒìƒ‰ì /ì°½ì˜ì  ê²€ìƒ‰
```python
score_threshold: float = 0.8

# ì˜ˆ: ì•„ì´ë””ì–´ ë¸Œë ˆì¸ìŠ¤í† ë°, ì˜ê° ì°¾ê¸°
# - ëŠìŠ¨í•œ ì—°ê´€ì„±ë„ í—ˆìš©
# - ë‹¤ì–‘í•œ ê´€ì  ì œì‹œ
```

### ì„ê³„ê°’ ë³€ê²½ ë°©ë²•

**ë°©ë²• 1: ì½”ë“œ ì§ì ‘ ìˆ˜ì •**

íŒŒì¼: `backend/rag/retriever.py:21`

```python
# ë³€ê²½ ì „
score_threshold: float = 0.5

# ë³€ê²½ í›„ (ê¶Œì¥)
score_threshold: float = 0.65
```

**ë°©ë²• 2: í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš© (ì¶”ì²œ)**

1. `.env` íŒŒì¼ì— ì¶”ê°€:
```env
RAG_SCORE_THRESHOLD=0.65
```

2. `retriever.py` ìˆ˜ì •:
```python
import os

class Retriever:
    def __init__(
        self,
        embeddings: BGEEmbeddings = None,
        vector_store: ChromaVectorStore = None,
        top_k: int = 3,
        score_threshold: float = None
    ):
        # í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì½ê¸°, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 0.65
        if score_threshold is None:
            score_threshold = float(os.getenv("RAG_SCORE_THRESHOLD", "0.65"))

        self.score_threshold = score_threshold
```

**ë°©ë²• 3: API íŒŒë¼ë¯¸í„°ë¡œ ë™ì  ì¡°ì •**

`main.py`ì˜ `/api/rag-chat` ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •:

```python
class ChatRequest(BaseModel):
    message: str
    conversation_history: List[Dict[str, str]] = []
    score_threshold: Optional[float] = 0.65  # í´ë¼ì´ì–¸íŠ¸ê°€ ì¡°ì • ê°€ëŠ¥

@app.post("/api/rag-chat")
async def rag_chat(request: ChatRequest):
    rag = get_rag_chain()

    # ì„ê³„ê°’ ë™ì  ì„¤ì •
    rag.retriever.score_threshold = request.score_threshold

    result = rag.run(
        query=request.message,
        conversation_history=request.conversation_history
    )
    # ...
```

### ìµœì  ì„ê³„ê°’ ì°¾ê¸° ì‹¤í—˜

**A/B í…ŒìŠ¤íŠ¸ ë°©ë²•:**

1. **í…ŒìŠ¤íŠ¸ ì§ˆë¬¸ ì„¸íŠ¸ ì¤€ë¹„** (20~30ê°œ)
```python
test_questions = [
    "ê°•ë‚¨ì—ì„œ ì¹´í˜ ì°½ì—… ë¹„ìš©ì€?",
    "ìƒê¶Œ ë¶„ì„ ì–´ë–»ê²Œ í•´?",
    "ì°½ì—…í•  ë•Œ í•„ìš”í•œ ì„œë¥˜ëŠ”?",
    # ... ë” ë§ì€ ì§ˆë¬¸
]
```

2. **ì—¬ëŸ¬ ì„ê³„ê°’ìœ¼ë¡œ ì‹¤í—˜**
```python
thresholds = [0.4, 0.5, 0.6, 0.7, 0.8]

for threshold in thresholds:
    retriever = Retriever(score_threshold=threshold)

    success_count = 0
    for question in test_questions:
        results = retriever.search(question)
        if len(results) > 0:
            success_count += 1

    success_rate = (success_count / len(test_questions)) * 100
    print(f"Threshold {threshold}: {success_rate}% ê²€ìƒ‰ ì„±ê³µë¥ ")
```

3. **ê²°ê³¼ ë¶„ì„**
```
ì˜ˆìƒ ê²°ê³¼:
Threshold 0.4: 40% ê²€ìƒ‰ ì„±ê³µë¥  (ë„ˆë¬´ ì—„ê²©)
Threshold 0.5: 55% ê²€ìƒ‰ ì„±ê³µë¥  (í˜„ì¬)
Threshold 0.6: 75% ê²€ìƒ‰ ì„±ê³µë¥  (ê¶Œì¥)
Threshold 0.7: 90% ê²€ìƒ‰ ì„±ê³µë¥  (ê· í˜•)
Threshold 0.8: 95% ê²€ìƒ‰ ì„±ê³µë¥  (ë„ˆë¬´ ëŠìŠ¨)
```

### ê¸°íƒ€ íŠœë‹ í¬ì¸íŠ¸

#### 1. top_k ì¡°ì •

```python
# í˜„ì¬
top_k: int = 3  # ìµœëŒ€ 3ê°œ ê²€ìƒ‰

# ë” ë§ì€ ë¬¸ì„œ ê²€ìƒ‰
top_k: int = 5  # ìµœëŒ€ 5ê°œ ê²€ìƒ‰
â†’ ë” ë‹¤ì–‘í•œ ì •ë³´ ì œê³µ
â†’ LLM í† í° ë¹„ìš© ì¦ê°€
â†’ ì‘ë‹µ ì†ë„ ì•½ê°„ ëŠë ¤ì§

# ë” ì ì€ ë¬¸ì„œ ê²€ìƒ‰
top_k: int = 1  # ìµœëŒ€ 1ê°œë§Œ
â†’ ë¹ ë¥¸ ì‘ë‹µ
â†’ í† í° ë¹„ìš© ì ˆê°
â†’ ì •ë³´ ë¶€ì¡±í•  ìˆ˜ ìˆìŒ
```

#### 2. í•„í„°ë§ ë¹„í™œì„±í™”

```python
# ì„ê³„ê°’ 0 ì´í•˜ë¡œ ì„¤ì •
score_threshold: float = 0.0
â†’ ëª¨ë“  ë¬¸ì„œ í†µê³¼ (í•„í„°ë§ ì•ˆ í•¨)
â†’ í•­ìƒ top_kê°œ ë°˜í™˜
â†’ í’ˆì§ˆ ë‚®ì€ ë¬¸ì„œë„ í¬í•¨ë  ìˆ˜ ìˆìŒ
```

#### 3. í•˜ì´ë¸Œë¦¬ë“œ ì „ëµ

```python
def search_with_fallback(query: str):
    # 1ì°¨: ì—„ê²©í•œ ê¸°ì¤€
    results = retriever.search(query, score_threshold=0.5)

    if len(results) == 0:
        # 2ì°¨: ëŠìŠ¨í•œ ê¸°ì¤€ìœ¼ë¡œ ì¬ê²€ìƒ‰
        print("[FALLBACK] ëŠìŠ¨í•œ ê¸°ì¤€ìœ¼ë¡œ ì¬ê²€ìƒ‰...")
        results = retriever.search(query, score_threshold=0.7)

    return results
```

---

## ìš”ì•½

### í•µì‹¬ í¬ì¸íŠ¸

1. **Distance vs Similarity**
   - Distance: 0(ìœ ì‚¬) ~ 2(ë‹¤ë¦„)
   - Similarity: 100%(ìœ ì‚¬) ~ 0%(ë‹¤ë¦„)
   - ê³µì‹: `similarity = 1 - (distance / 2)`

2. **âš ï¸ score_thresholdì˜ ì§„ì‹¤**
   - **ë³€ìˆ˜ëª…ì´ score_thresholdì§€ë§Œ Distance ê¸°ì¤€ì„!**
   - `threshold = 0.5` â‰  ìœ ì‚¬ë„ 50%
   - `threshold = 0.5` = Distance 0.5 = **ìœ ì‚¬ë„ 75%**
   - ë§ì€ ì‚¬ëŒë“¤ì´ ì˜¤í•´í•˜ëŠ” ë¶€ë¶„!

3. **ì„ê³„ê°’ í•„í„°ë§**
   - í˜„ì¬: `distance <= 0.5` (ìœ ì‚¬ë„ 75% ì´ìƒ)
   - ChromaDBê°€ ì°¾ì€ ë¬¸ì„œë„ ê¸°ì¤€ ë¯¸ë‹¬ì´ë©´ ë²„ë¦¼
   - ê²€ìƒ‰ ê²°ê³¼ 0ê±´ ë°œìƒ ê°€ëŠ¥

4. **0ê±´ì¼ ë•Œ ì²˜ë¦¬**
   - LLM í˜¸ì¶œ ì•ˆ í•¨ (í† í° ì ˆì•½)
   - ê³ ì • ë©”ì‹œì§€: "ê´€ë ¨ ì •ë³´ ì—†ìŒ"
   - ì¶œì²˜ í‘œì‹œ ì•ˆ ë¨

5. **íŠœë‹ ê¶Œì¥ì‚¬í•­**
   - í˜„ì¬ í”„ë¡œì íŠ¸: `0.65` (Distance) = 67.5% (Similarity) ê¶Œì¥
   - ì¼ë°˜ Q&A: `0.6~0.7` (Distance) = 65~70% (Similarity)
   - ì „ë¬¸ ë¶„ì•¼: `0.4~0.5` (Distance) = 75~80% (Similarity)

### ì˜ì‚¬ê²°ì • í”Œë¡œìš°ì°¨íŠ¸

```
ì‚¬ìš©ì ì§ˆë¬¸
    â†“
ì„ë² ë”© ìƒì„±
    â†“
ChromaDB ê²€ìƒ‰ (top_kê°œ)
    â†“
ê° ë¬¸ì„œ distance í™•ì¸
    â†“
distance <= 0.5?
    â”œâ”€ YES â†’ ë¬¸ì„œ ì¶”ê°€
    â””â”€ NO â†’ í•„í„°ë§
    â†“
ê²°ê³¼ ê°œìˆ˜ í™•ì¸
    â”œâ”€ 0ê°œ â†’ "ê´€ë ¨ ì •ë³´ ì—†ìŒ" ë°˜í™˜
    â””â”€ 1ê°œ ì´ìƒ â†’ LLM í˜¸ì¶œ â†’ ë‹µë³€ ìƒì„±
```

### ì‹¤ë¬´ íŒ

1. **ì²˜ìŒ ë°°í¬í•  ë•Œ**
   - ì„ê³„ê°’ 0.7ë¡œ ì‹œì‘ (ê²€ìƒ‰ ì„±ê³µë¥  ìš°ì„ )
   - ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘
   - ì ì§„ì ìœ¼ë¡œ ì¡°ì •

2. **í’ˆì§ˆ vs ì»¤ë²„ë¦¬ì§€**
   - í’ˆì§ˆ ì¤‘ìš” â†’ ë‚®ì€ ì„ê³„ê°’ (0.4~0.5)
   - ì»¤ë²„ë¦¬ì§€ ì¤‘ìš” â†’ ë†’ì€ ì„ê³„ê°’ (0.7~0.8)
   - ê· í˜• â†’ 0.6~0.65

3. **ëª¨ë‹ˆí„°ë§ ì§€í‘œ**
   - ê²€ìƒ‰ ì„±ê³µë¥  (0ê±´ ë¹„ìœ¨)
   - í‰ê·  ìœ ì‚¬ë„ ì ìˆ˜
   - ì‚¬ìš©ì ë§Œì¡±ë„

---

**ì‘ì„±ì¼:** 2025-11-21
**ë²„ì „:** 1.0
**í”„ë¡œì íŠ¸:** commercial-analysis RAG System
